#! /usr/bin/env bash
BASEDIR=$(dirname $0); cd $BASEDIR

. ../.libs/funcs
. ../env-vars

_require_var OPEN_WEBUI_WAIT_SECS
_require_var OPEN_WEBUI_WAIT_TRIES

_usage() {
    echo "Starts Ollama service and the Open WebUI."
    echo ;
    echo "Usage: $0 [<option>]*"
    echo "Option:"
    echo "    -o: Stop the current Open WebUI container"
    echo "    -r: Remove the current Open WebUI container"
    echo "    -h: Displays this help message"
    exit 0
}

_remove_container() {
    echo "Removing open-webui-cuda ..."
    docker rm -f open-webui-cuda

    echo "Removing open-webui-main ..."
    docker rm -f open-webui-main
    
    _completed
}

_stop_container() {
    if [ -n "$(docker ps -q -a -f name=open-webui-cuda)" ]; then
        echo "Stopping open-webui-cuda ..."
        docker container stop open-webui-cuda
    fi

    if [ -n "$(docker ps -q -a -f name=open-webui-main)" ]; then
        echo "Stopping open-webui-main ..."
        docker container stop open-webui-main
    fi

    _completed
}

_with_gpus=""

while getopts "srh" opt; do
    case "$opt" in
        s)
            _stop_container
            ;;
        r)
            _remove_container
            ;;
        h)
            _usage
            ;;
    esac
done

if ! [ "$( systemctl is-active ollama )" = "active" ]; then
    ollama serve
fi

_recognized_container=""

if [ -z "$(docker ps -q -a -f name=open-webui-cuda)" ]; then
    echo ;
    echo "Attempting to run open-webui-cuda ..."

    docker run -d --network=host -e OLLAMA_BASE_URL=http://127.0.0.1:11434 --gpus all -v open-webui:/app/backend/data --name open-webui-cuda ghcr.io/open-webui/open-webui:cuda
else
    echo ;
    echo "Attempting to restart open-webui-cuda ..."

    docker container restart open-webui-cuda
fi

if ! [ $? -eq 0 ]; then
    echo ;
    echo "Unable to run open-webui-cuda"

    if [ -z "$(docker ps -q -a -f name=open-webui-main)" ]; then
        echo ;
        echo "Attempting to run open-webui-main ..."

        docker run -d --network=host -e OLLAMA_BASE_URL=http://127.0.0.1:11434 -v open-webui:/app/backend/data --name open-webui-main ghcr.io/open-webui/open-webui:main
    else
        echo ;
        echo "Attempting to restart open-webui-main ..."

        docker container restart open-webui-main
    fi

    _recognized_container=open-webui-main
else
    _recognized_container=open-webui-cuda
fi

_recognized_container_id="$(docker ps -q -a -f name=$_recognized_container)"

_waiting_flag=0
_waited=0

while [ $_waiting_flag -eq 0 ]; do
    echo "Waiting for $_recognized_container to run..."

    if ! [ "$(docker inspect --format='{{.State.Health.Status}}' $_recognized_container_id)" = "healthy" ]; then
        sleep $OPEN_WEBUI_WAIT_SECS
        let "_waited+=1"

        if [ $_waited -eq $OPEN_WEBUI_WAIT_TRIES ]; then
            echo "Waited $(($OPEN_WEBUI_WAIT_SECS * $OPEN_WEBUI_WAIT_TRIES)) seconds, $_recognized_container is still not running."
            exit 1
        fi
    else
        _waiting_flag=1
    fi
done

echo "> http://localhost:8080"

_completed
