#! /usr/bin/env bash
BASEDIR=$(dirname $0); cd $BASEDIR

. ../.libs/funcs
. ../env-vars

_require_var OPEN_WEBUI_WAIT_SECS
_require_var OPEN_WEBUI_WAIT_TRIES

_usage() {
    echo "Starts Ollama service and the Open WebUI."
    echo ;
    echo "Usage: $0 [<option>]*"
    echo "Option:"
    echo "    -r: Remove the current Open WebUI container"
    echo "    -h: Displays this help message"
    exit 0
}

_remove_container() {
    local _container_id="$(docker ps -q -a -f name=open-webui-cuda)"

    if ! [[ -z "$_container_id" ]]; then
        docker rm "$_container_id"
    fi

    _container_id="$(docker ps -q -a -f name=open-webui-main)"

    if ! [[ -z "$_container_id" ]]; then
        docker rm "$_container_id"
    fi
    
    _completed
}

_with_gpus=""

while getopts "rh" opt; do
    case "$opt" in
        r)
            _remove_container
            ;;
        h)
            _usage
            ;;
    esac
done

if ! [ "$( systemctl is-active ollama )" = "active" ]; then
    ollama serve
fi

_recognized_container=""

if [[ -z "$(docker ps -q -a -f name=open-webui-cuda)" ]]; then
    docker run -d --network=host -e OLLAMA_BASE_URL=http://127.0.0.1:11434 --gpus all -v open-webui:/app/backend/data --name open-webui-cuda ghcr.io/open-webui/open-webui:cuda
else
    docker container restart open-webui-cuda
fi

if ! [ $? -eq 0 ]; then
    if [[ -z "$(docker ps -q -a -f name=open-webui-main)" ]]; then
        docker run -d --network=host -e OLLAMA_BASE_URL=http://127.0.0.1:11434 -v open-webui:/app/backend/data --name open-webui ghcr.io/open-webui/open-webui:main
    else
        docker container restart open-webui-main
    fi

    _recognized_container=open-webui-main
else
    _recognized_container=open-webui-cuda
fi

_waiting_flag=0
_waited=0

while [ $_waiting_flag -eq 0 ]; do
    
    if [[ -z "$(docker ps -q -a -f name=$_recognized_container -f status=running)" ]]; then
        sleep $OPEN_WEBUI_WAIT_SECS
        let "_waited+=1"

        if [ $_waited -eq $OPEN_WEBUI_WAIT_TRIES ]; then
            echo "Waited $(($OPEN_WEBUI_WAIT_SECS * $OPEN_WEBUI_WAIT_TRIES)) seconds, $_recognized_container is still not running."
            exit 1
        fi
    else
        _waiting_flag=1
    fi
done

echo "> http://localhost:8080"

_completed
